<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Inspeksi Bahan Baku - AG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700&display=swap" rel="stylesheet">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF & AutoTable CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <link rel="icon" href="ag-logo.svg">
  <style>
    :root {
      --primary: #00c6ff;
      --primary-dark: #0072ff;
      --bg: #181c24;
      --bg-light: #232836;
      --sidebar: #101319ee;
      --sidebar-accent: #222739;
      --text: #e7e7e7;
      --text-muted: #929292;
      --accent: #00ffc6;
      --danger: #ff4d4f;
      --input-bg: #23293a;
      --border-radius: 12px;
      --shadow: 0px 6px 18px 0px rgba(0,0,0,0.18);
      --sidebar-width: 230px;
    }
    html, body {
      background: var(--bg);
      font-family: 'Montserrat', Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: var(--text);
      min-height: 100vh;
    }
    body {
      /* Background pabrik spinning (placeholder Unsplash, bisa diganti dengan gambar sendiri) */
      background: var(--bg) url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1200&q=80') no-repeat center center fixed;
      background-size: cover;
    }
    .bg-overlay {
      position: fixed;
      top:0;left:0;right:0;bottom:0;
      background: linear-gradient(120deg, #181c24ee 70%, #0072ff44 100%);
      z-index: 0;
      pointer-events: none;
    }
    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: var(--sidebar-width);
      background: var(--sidebar);
      box-shadow: 4px 0 18px 0 #0004;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 2;
      transition: transform 0.26s;
      border-top-right-radius: 30px;
      border-bottom-right-radius: 30px;
    }
    .logo-box {
      margin: 36px 0 28px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .logo-img {
      width: 54px;
      height: 54px;
      margin-bottom: 3px;
      border-radius: 13px;
      background: #0f1822;
      box-shadow: 0 0 16px #00c6ff44;
    }
    .sidebar-title {
      color: var(--primary);
      font-weight: 700;
      font-size: 1.3rem;
      letter-spacing: 2px;
      margin-top: 4px;
      margin-bottom: 18px;
    }
    .sidebar-menu {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .sidebar-menu button {
      width: 90%;
      margin: 6px auto;
      background: none;
      border: none;
      color: var(--text);
      text-align: left;
      padding: 13px 24px 13px 28px;
      font-size: 1rem;
      border-radius: 8px;
      font-weight: 600;
      letter-spacing: 1px;
      cursor: pointer;
      transition: background 0.18s, color 0.2s, transform 0.14s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .sidebar-menu button.active,
    .sidebar-menu button:hover {
      background: linear-gradient(90deg, #0072ff44, #00c6ff22 100%);
      color: var(--primary);
      transform: translateX(7px) scale(1.03);
    }
    .sidebar-footer {
      margin: 18px 0 16px 0;
      color: var(--text-muted);
      font-size: 0.93em;
      text-align: center;
    }
    .sidebar .logout-btn {
      margin: 0 0 18px 0;
      width: 90%;
      background: linear-gradient(90deg, var(--danger), #b5001f 100%);
      color: #fff;
      font-weight: 700;
      letter-spacing: 2px;
      padding: 11px 0;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 12px 0px #ff4d4f25;
      transition: background 0.22s, transform 0.1s;
      font-size: 1em;
      cursor: pointer;
    }
    .sidebar .logout-btn:hover {
      background: linear-gradient(90deg, #b5001f, var(--danger) 100%);
      transform: scale(1.04);
    }

    /* Main content */
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 36px 24px 32px 24px;
      min-height: 100vh;
      z-index: 1;
      position: relative;
      transition: margin-left 0.2s;
    }
    .main-content .page {
      display: none;
      animation: fadeIn 0.7s;
    }
    .main-content .page.active {
      display: block;
    }

    /* Login overlay */
    .login-overlay {
      position: fixed;
      top:0;left:0;right:0;bottom:0;
      background: rgba(24,28,36,0.97);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      width: 100vw;
    }
    .login-box {
      background: var(--bg-card, #222739);
      padding: 40px 38px 36px 38px;
      border-radius: 18px;
      box-shadow: 0 8px 44px #0005;
      text-align: center;
      min-width: 350px;
      animation: fadeIn 1.1s;
    }
    .login-logo {
      width: 68px;
      height: 68px;
      margin-bottom: 16px;
      border-radius: 16px;
      box-shadow: 0 0 18px #00c6ff33;
      background: #101319;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      margin-right: auto;
    }
    .login-title {
      color: var(--primary);
      font-size: 1.6rem;
      letter-spacing: 2px;
      font-weight: 700;
      margin-bottom: 24px;
    }
    .login-box input {
      width: 89%;
      padding: 12px 14px;
      font-size: 1em;
      border-radius: 8px;
      border: none;
      background: var(--input-bg);
      color: var(--text);
      margin-bottom: 17px;
      margin-top: 2px;
      outline: none;
      box-shadow: 0 2px 10px 0px rgba(0,198,255,0.07);
      font-family: inherit;
      transition: box-shadow 0.3s;
    }
    .login-box input:focus {
      box-shadow: 0 0 0 2px var(--primary);
    }
    .login-box button {
      width: 100%;
      padding: 13px;
      font-size: 1.1em;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, var(--primary-dark), var(--primary));
      color: #fff;
      font-weight: 700;
      margin-top: 10px;
      letter-spacing: 1.5px;
      box-shadow: 0 2px 12px 0px #00c6ff25;
      cursor: pointer;
      transition: background 0.22s, transform 0.1s;
    }
    .login-box button:hover {
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      transform: scale(1.03);
    }
    .login-error {
      color: var(--danger);
      margin-bottom: 13px;
      font-size: 0.97em;
      min-height: 20px;
    }
    @media (max-width: 800px) {
      .sidebar { width: 54px; overflow-x: hidden;}
      .sidebar-title, .sidebar-footer, .sidebar-menu button span.label { display: none;}
      .sidebar-menu button { padding: 12px 14px;}
      .main-content { margin-left: 54px; padding: 18px 2vw 22px 2vw;}
      .login-box { min-width: 90vw;}
    }
    @media (max-width: 460px) {
      .login-box { padding: 16px 2vw;}
      .main-content { padding: 10px 0 10px 0;}
    }
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(-25px);}
      100% { opacity: 1; transform: none;}
    }
  </style>
</head>
<body>
  <div class="bg-overlay"></div>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo-box">
      <img src="ag-logo.svg" alt="AG Logo" class="logo-img">
      <div class="sidebar-title">AG Inspeksi</div>
    </div>
    <div class="sidebar-menu" id="sidebarMenu">
      <button data-page="dashboard" class="active"><span class="label">Dashboard</span></button>
      <button data-page="inspeksi"><span class="label">Data Inspeksi</span></button>
      <button data-page="export"><span class="label">Export Data</span></button>
      <button data-page="pengaturan"><span class="label">Pengaturan</span></button>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
    <div class="sidebar-footer">
      <div>Kontak: admin@agspinning.com</div>
      <div>Email: admin@agspinning.com</div>
    </div>
  </div>
  <!-- Main content -->
  <div class="main-content">
    <!-- Dashboard Page -->
    <div class="page active" id="page-dashboard">
      <h1>Dashboard Inspeksi</h1>
      <canvas id="chartInspeksi" height="110"></canvas>
      <div style="margin-top:30px;">
        <h2>Ringkasan Checklist Visual</h2>
        <canvas id="chartChecklist" height="80"></canvas>
      </div>
    </div>
    <!-- Data Inspeksi Page -->
    <div class="page" id="page-inspeksi">
      <h1>Data Inspeksi Bahan Baku</h1>
      <div id="inspeksiApp"></div>
    </div>
    <!-- Export Page -->
    <div class="page" id="page-export">
      <h1>Export Data Inspeksi</h1>
      <div id="exportApp"></div>
    </div>
    <!-- Pengaturan Page -->
    <div class="page" id="page-pengaturan">
      <h1>Pengaturan Admin</h1>
      <div>
        <h3>Ganti Password Admin</h3>
        <form id="formGantiPassword" autocomplete="off">
          <input type="password" id="oldPassword" placeholder="Password lama" required><br>
          <input type="password" id="newPassword" placeholder="Password baru" required><br>
          <input type="password" id="confirmPassword" placeholder="Konfirmasi password baru" required><br>
          <button type="submit">Ganti Password</button>
        </form>
        <div id="passwordMsg" style="color:#00ffc6;margin-top:8px;"></div>
      </div>
    </div>
  </div>
  <!-- LOGIN OVERLAY -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <div class="login-logo"><img src="ag-logo.svg" width="48" alt="AG"></div>
      <div class="login-title">AG Inspeksi</div>
      <div class="login-error" id="loginError"></div>
      <input type="text" id="loginUser" placeholder="Username" autofocus>
      <input type="password" id="loginPass" placeholder="Password">
      <button onclick="login()">Login</button>
    </div>
  </div>
  <!-- SheetJS CDN for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <script>
    // ===== LOGIN LOGIC =====
    let admins = [
      {user:'admin1', pass:'admin123'},
      {user:'admin2', pass:'admin456'}
    ];
    if(localStorage.getItem('admins')) admins = JSON.parse(localStorage.getItem('admins'));
    function login() {
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value;
      const idx = admins.findIndex(a => a.user === u && a.pass === p);
      if(idx !== -1) {
        sessionStorage.setItem('adminLogin', u);
        document.getElementById('loginOverlay').style.display = 'none';
      } else {
        document.getElementById('loginError').innerText = "Username atau password salah!";
      }
    }
    function logout() {
      sessionStorage.removeItem('adminLogin');
      location.reload();
    }
    window.onload = function() {
      if(sessionStorage.getItem('adminLogin')) {
        document.getElementById('loginOverlay').style.display = 'none';
        renderDashboard();
      }
    };
    // ===== SIDEBAR NAVIGATION =====
    document.querySelectorAll('.sidebar-menu button').forEach(btn => {
      btn.onclick = function() {
        document.querySelectorAll('.sidebar-menu button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.main-content .page').forEach(pg=>pg.classList.remove('active'));
        document.getElementById('page-'+btn.dataset.page).classList.add('active');
        if(btn.dataset.page==='dashboard') renderDashboard();
        if(btn.dataset.page==='inspeksi') renderInspeksiApp();
        if(btn.dataset.page==='export') renderExportApp();
      };
    });
    // ===== DASHBOARD CHARTS =====
    function renderDashboard() {
      let data = JSON.parse(localStorage.getItem('inspeksiBahanBaku')||'[]');
      let perBulan = {};
      data.forEach(i=>{
        if(!i.tanggal) return;
        let bln = i.tanggal.slice(0,7);
        perBulan[bln] = (perBulan[bln]||0)+1;
      });
      let labels = Object.keys(perBulan).sort();
      let values = labels.map(k=>perBulan[k]);
      let ctx = document.getElementById('chartInspeksi').getContext('2d');
      if(window._chartInspeksi) window._chartInspeksi.destroy();
      window._chartInspeksi = new Chart(ctx, {
        type: 'bar',
        data: {labels, datasets:[{label:"Jumlah Inspeksi", data:values, backgroundColor: 'rgba(0,198,255,0.6)'}]},
        options: {plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}}}
      });
      let checklist = {Tekstur:0, WarnaSeragam:0, TidakMenggumpal:0, BebasKontaminasi:0, Stabil:0};
      data.forEach(i=>{
        if(i.tekstur) checklist.Tekstur++;
        if(i.warnaSeragam) checklist.WarnaSeragam++;
        if(i.tidakMenggumpal) checklist.TidakMenggumpal++;
        if(i.bebasKontaminasi) checklist.BebasKontaminasi++;
        if(i.stabilDisimpan) checklist.Stabil++;
      });
      let ctx2 = document.getElementById('chartChecklist').getContext('2d');
      if(window._chartChecklist) window._chartChecklist.destroy();
      window._chartChecklist = new Chart(ctx2, {
        type: 'pie',
        data: {labels: Object.keys(checklist), datasets:[{data:Object.values(checklist), backgroundColor:['#00c6ff','#00ffc6','#0072ff','#26e6ff','#0ddacd']}]},
        options: {plugins:{legend:{labels:{color:'#fff'}}}}
      });
    }
    setTimeout(renderDashboard, 500);
    // ===== DATA INSPEKSI APP =====
    function renderInspeksiApp() {
      document.getElementById('inspeksiApp').innerHTML = `
      <form id="formInspeksi" autocomplete="off" style="background:rgba(34,39,57,0.96);padding:22px;border-radius:12px;box-shadow:0 0 24px #0004;max-width:700px;margin:25px auto;">
        <div style="font-weight:700;font-size:1.08em;margin-bottom:18px;color:#00c6ff">Informasi Dasar</div>
        <label>Supplier</label>
        <input type="text" id="supplier" required>
        <label>Tanggal Inspeksi</label>
        <input type="date" id="tanggal" required>
        <div style="font-weight:700;font-size:1.08em;margin:23px 0 11px 0;color:#00c6ff">Ringkasan Kualitas Bahan Baku</div>
        <label>Bentuk</label>
        <input type="text" id="bentuk">
        <label>Warna</label>
        <input type="text" id="warna">
        <label>Kelembaban</label>
        <input type="text" id="kelembaban">
        <label>Kontaminasi</label>
        <input type="text" id="kontaminasi">
        <label>Ukuran Partikel</label>
        <input type="text" id="ukuran">
        <label>Flowability</label>
        <input type="text" id="flowability">
        <div style="font-weight:700;font-size:1.08em;margin:23px 0 11px 0;color:#00c6ff">Kesimpulan dan Rekomendasi</div>
        <label>Kesimpulan</label>
        <textarea id="kesimpulan"></textarea>
        <label>Rekomendasi</label>
        <textarea id="rekomendasi"></textarea>
        <div style="font-weight:700;font-size:1.08em;margin:23px 0 13px 0;color:#00c6ff">Checklist Evaluasi Visual</div>
        <div style="display:flex;flex-wrap:wrap;gap:18px;">
          <label><input type="checkbox" id="tekstur">Tekstur Halus</label>
          <label><input type="checkbox" id="warnaSeragam">Warna Seragam</label>
          <label><input type="checkbox" id="tidakMenggumpal">Tidak Menggumpal</label>
          <label><input type="checkbox" id="bebasKontaminasi">Bebas Kontaminasi Visual</label>
          <label><input type="checkbox" id="stabilDisimpan">Stabil saat Disimpan</label>
        </div>
        <div style="font-weight:700;font-size:1.08em;margin:23px 0 11px 0;color:#00c6ff">Dokumentasi Foto Bahan Baku</div>
        <input type="file" id="foto" accept="image/*">
        <button type="submit" style="margin-top:16px">Simpan</button>
      </form>
      <div class="search-container" style="text-align:center;margin-top:18px;margin-bottom:6px;">
        <label>Cari: </label>
        <input type="text" id="search" placeholder="Cari semua kolom..." style="background:#23293a;padding:8px 14px;border-radius:6px;border:none;color:#fff;">
      </div>
      <table id="tabelInspeksi" style="width:99%;margin:auto;margin-top:18px;background:rgba(34,39,57,0.95);border-radius:12px;box-shadow:0 2px 16px #0005;">
        <thead>
          <tr style="color:#00c6ff">
            <th>No</th><th>Supplier</th><th>Tgl</th><th>Bentuk</th><th>Warna</th><th>Kelembaban</th><th>Kontaminasi</th><th>Ukuran Partikel</th><th>Flowability</th>
            <th>Kesimpulan</th><th>Rekomendasi</th>
            <th>Tekstur Halus</th><th>Warna Seragam</th><th>Tidak Menggumpal</th><th>Bebas Kontaminasi Visual</th><th>Stabil Disimpan</th>
            <th>Foto</th><th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="text-align:center;margin:20px 0;">
        <button class="export-btn" onclick="exportExcel()">Export Excel</button>
        <button class="export-btn" onclick="exportCSV()">Export CSV</button>
        <button class="export-btn" onclick="exportPDF()">Export PDF</button>
        <button class="export-btn" onclick="exportJSON()">Export JSON</button>
        <button class="export-btn" onclick="exportTXT()">Export TXT</button>
        <button class="export-btn" onclick="exportXML()">Export XML</button>
      </div>
      `;
      // LOGIC FORM & TABEL
      let dataInspeksi = JSON.parse(localStorage.getItem('inspeksiBahanBaku')||'[]');
      const tabel = document.getElementById('tabelInspeksi').getElementsByTagName('tbody')[0];
      const searchInput = document.getElementById('search');
      const fotoInput = document.getElementById('foto');
      function renderTabel(data) {
        tabel.innerHTML = '';
        data.forEach((item, idx) => {
          const row = tabel.insertRow();
          row.insertCell(0).innerText = idx + 1;
          row.insertCell(1).innerText = item.supplier;
          row.insertCell(2).innerText = item.tanggal;
          row.insertCell(3).innerText = item.bentuk;
          row.insertCell(4).innerText = item.warna;
          row.insertCell(5).innerText = item.kelembaban;
          row.insertCell(6).innerText = item.kontaminasi;
          row.insertCell(7).innerText = item.ukuran;
          row.insertCell(8).innerText = item.flowability;
          row.insertCell(9).innerText = item.kesimpulan;
          row.insertCell(10).innerText = item.rekomendasi;
          row.insertCell(11).innerText = item.tekstur ? "✔" : "";
          row.insertCell(12).innerText = item.warnaSeragam ? "✔" : "";
          row.insertCell(13).innerText = item.tidakMenggumpal ? "✔" : "";
          row.insertCell(14).innerText = item.bebasKontaminasi ? "✔" : "";
          row.insertCell(15).innerText = item.stabilDisimpan ? "✔" : "";
          // Foto
          const fotoCell = row.insertCell(16);
          if (item.foto) {
            const img = document.createElement('img');
            img.src = item.foto;
            img.alt = 'Foto Bahan Baku';
            img.style.maxWidth = "60px";
            img.style.maxHeight = "60px";
            img.style.borderRadius = "7px";
            img.style.boxShadow = "0 0 8px #00c6ff44";
            img.style.border = "2px solid #0072ff";
            img.style.background = "#181c24";
            img.style.objectFit = "cover";
            fotoCell.appendChild(img);
          }
          // Tombol hapus
          const aksiCell = row.insertCell(17);
          const btnHapus = document.createElement('button');
          btnHapus.innerText = 'Hapus';
          btnHapus.style.background = 'linear-gradient(90deg, #ff4d4f, #b5001f)';
          btnHapus.style.color = '#fff';
          btnHapus.style.border = 'none';
          btnHapus.style.padding = '6px 12px';
          btnHapus.style.borderRadius = '5px';
          btnHapus.style.cursor = 'pointer';
          btnHapus.onclick = function() {
            if(confirm('Yakin ingin menghapus data ini?')) {
              dataInspeksi.splice(idx, 1);
              simpanData();
              renderTabel(filteredData());
              renderDashboard();
            }
          };
          aksiCell.appendChild(btnHapus);
        });
      }
      function simpanData() {
        localStorage.setItem('inspeksiBahanBaku', JSON.stringify(dataInspeksi));
      }
      function filteredData() {
        const keyword = searchInput.value.trim().toLowerCase();
        if (!keyword) return dataInspeksi;
        return dataInspeksi.filter(item =>
          Object.values(item).some(val =>
            typeof val === 'string' && val.toLowerCase().includes(keyword)
          )
        );
      }
      renderTabel(filteredData());
      searchInput.addEventListener('input', function() {
        renderTabel(filteredData());
      });
      document.getElementById('formInspeksi').onsubmit = function(e) {
        e.preventDefault();
        const data = {
          supplier: document.getElementById('supplier').value,
          tanggal: document.getElementById('tanggal').value,
          bentuk: document.getElementById('bentuk').value,
          warna: document.getElementById('warna').value,
          kelembaban: document.getElementById('kelembaban').value,
          kontaminasi: document.getElementById('kontaminasi').value,
          ukuran: document.getElementById('ukuran').value,
          flowability: document.getElementById('flowability').value,
          kesimpulan: document.getElementById('kesimpulan').value,
          rekomendasi: document.getElementById('rekomendasi').value,
          tekstur: document.getElementById('tekstur').checked,
          warnaSeragam: document.getElementById('warnaSeragam').checked,
          tidakMenggumpal: document.getElementById('tidakMenggumpal').checked,
          bebasKontaminasi: document.getElementById('bebasKontaminasi').checked,
          stabilDisimpan: document.getElementById('stabilDisimpan').checked,
          foto: ""
        };
        const file = fotoInput.files[0];
        if(file) {
          const reader = new FileReader();
          reader.onload = function(evt) {
            data.foto = evt.target.result;
            simpanInspeksi(data);
          };
          reader.readAsDataURL(file);
        } else {
          simpanInspeksi(data);
        }
      };
      function simpanInspeksi(obj) {
        dataInspeksi.push(obj);
        simpanData();
        renderTabel(filteredData());
        renderDashboard();
        document.getElementById('formInspeksi').reset();
      }
      // EXPORT BUTTONS
      window.exportExcel = function() {
        let wb = XLSX.utils.book_new();
        let ws_data = [[
          "No", "Supplier", "Tanggal", "Bentuk", "Warna", "Kelembaban", "Kontaminasi", "Ukuran Partikel", "Flowability",
          "Kesimpulan", "Rekomendasi", "Tekstur Halus", "Warna Seragam", "Tidak Menggumpal", "Bebas Kontaminasi Visual", "Stabil saat Disimpan"
        ]];
        filteredData().forEach((item, idx) => {
          ws_data.push([
            idx+1, item.supplier, item.tanggal, item.bentuk, item.warna, item.kelembaban, item.kontaminasi, item.ukuran, item.flowability,
            item.kesimpulan, item.rekomendasi,
            item.tekstur ? "✔" : "", item.warnaSeragam ? "✔" : "", item.tidakMenggumpal ? "✔" : "", item.bebasKontaminasi ? "✔" : "", item.stabilDisimpan ? "✔" : ""
          ]);
        });
        let ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "InspeksiBahanBaku");
        XLSX.writeFile(wb, "Inspeksi_Bahan_Baku.xlsx");
      }
      window.exportCSV = function() {
        let rows = [[
          "No", "Supplier", "Tanggal", "Bentuk", "Warna", "Kelembaban", "Kontaminasi", "Ukuran Partikel", "Flowability",
          "Kesimpulan", "Rekomendasi", "Tekstur Halus", "Warna Seragam", "Tidak Menggumpal", "Bebas Kontaminasi Visual", "Stabil saat Disimpan"
        ]];
        filteredData().forEach((item, idx) => {
          rows.push([
            idx+1, item.supplier, item.tanggal, item.bentuk, item.warna, item.kelembaban, item.kontaminasi, item.ukuran, item.flowability,
            item.kesimpulan, item.rekomendasi,
            item.tekstur ? "✔" : "", item.warnaSeragam ? "✔" : "", item.tidakMenggumpal ? "✔" : "", item.bebasKontaminasi ? "✔" : "", item.stabilDisimpan ? "✔" : ""
          ]);
        });
        let csvContent = rows.map(e => e.map(x => `"${(x||'').toString().replace(/"/g,'""')}"`).join(",")).join("\n");
        let blob = new Blob([csvContent], {type: 'text/csv'});
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Inspeksi_Bahan_Baku.csv";
        link.click();
      }
      window.exportPDF = function() {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF('l', 'pt', 'a4');
        let head = [[
          "No", "Supplier", "Tanggal", "Bentuk", "Warna", "Kelembaban", "Kontaminasi", "Ukuran Partikel", "Flowability",
          "Kesimpulan", "Rekomendasi", "Tekstur Halus", "Warna Seragam", "Tidak Menggumpal", "Bebas Kontaminasi Visual", "Stabil saat Disimpan"
        ]];
        let body = filteredData().map((item, idx) => [
          idx+1, item.supplier, item.tanggal, item.bentuk, item.warna, item.kelembaban, item.kontaminasi, item.ukuran, item.flowability,
          item.kesimpulan, item.rekomendasi,
          item.tekstur ? "✔" : "", item.warnaSeragam ? "✔" : "", item.tidakMenggumpal ? "✔" : "", item.bebasKontaminasi ? "✔" : "", item.stabilDisimpan ? "✔" : ""
        ]);
        doc.text("Rekap Inspeksi Bahan Baku", 40, 30);
        doc.autoTable({
          head: head,
          body: body,
          startY: 50,
          styles: { fontSize: 8 }
        });
        doc.save("Inspeksi_Bahan_Baku.pdf");
      }
      window.exportJSON = function() {
        let data = filteredData();
        let blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Inspeksi_Bahan_Baku.json";
        link.click();
      }
      window.exportTXT = function() {
        let rows = [
          "No\tSupplier\tTanggal\tBentuk\tWarna\tKelembaban\tKontaminasi\tUkuran Partikel\tFlowability\tKesimpulan\tRekomendasi\tTekstur Halus\tWarna Seragam\tTidak Menggumpal\tBebas Kontaminasi Visual\tStabil saat Disimpan"
        ];
        filteredData().forEach((item, idx) => {
          rows.push([
            idx+1, item.supplier, item.tanggal, item.bentuk, item.warna, item.kelembaban, item.kontaminasi, item.ukuran, item.flowability,
            item.kesimpulan, item.rekomendasi,
            item.tekstur ? "✔" : "", item.warnaSeragam ? "✔" : "", item.tidakMenggumpal ? "✔" : "", item.bebasKontaminasi ? "✔" : "", item.stabilDisimpan ? "✔" : ""
          ].join("\t"));
        });
        let blob = new Blob([rows.join("\n")], {type: "text/plain"});
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Inspeksi_Bahan_Baku.txt";
        link.click();
      }
      window.exportXML = function() {
        let data = filteredData();
        let xml = '<?xml version="1.0" encoding="UTF-8"?><InspeksiBahanBaku>';
        data.forEach((item, idx) => {
          xml += `<Item>`;
          xml += `<No>${idx+1}</No>`;
          xml += `<Supplier>${escapeXml(item.supplier)}</Supplier>`;
          xml += `<Tanggal>${item.tanggal}</Tanggal>`;
          xml += `<Bentuk>${escapeXml(item.bentuk)}</Bentuk>`;
          xml += `<Warna>${escapeXml(item.warna)}</Warna>`;
          xml += `<Kelembaban>${escapeXml(item.kelembaban)}</Kelembaban>`;
          xml += `<Kontaminasi>${escapeXml(item.kontaminasi)}</Kontaminasi>`;
          xml += `<UkuranPartikel>${escapeXml(item.ukuran)}</UkuranPartikel>`;
          xml += `<Flowability>${escapeXml(item.flowability)}</Flowability>`;
          xml += `<Kesimpulan>${escapeXml(item.kesimpulan)}</Kesimpulan>`;
          xml += `<Rekomendasi>${escapeXml(item.rekomendasi)}</Rekomendasi>`;
          xml += `<TeksturHalus>${item.tekstur ? "true" : "false"}</TeksturHalus>`;
          xml += `<WarnaSeragam>${item.warnaSeragam ? "true" : "false"}</WarnaSeragam>`;
          xml += `<TidakMenggumpal>${item.tidakMenggumpal ? "true" : "false"}</TidakMenggumpal>`;
          xml += `<BebasKontaminasiVisual>${item.bebasKontaminasi ? "true" : "false"}</BebasKontaminasiVisual>`;
          xml += `<StabilSaatDisimpan>${item.stabilDisimpan ? "true" : "false"}</StabilSaatDisimpan>`;
          xml += `</Item>`;
        });
        xml += '</InspeksiBahanBaku>';
        let blob = new Blob([xml], {type: "application/xml"});
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Inspeksi_Bahan_Baku.xml";
        link.click();
      }
      function escapeXml(unsafe) {
        return (unsafe || '').replace(/[<>&'"]/g, function (c) {
          switch (c) {
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '&': return '&amp;';
            case '\'': return '&apos;';
            case '"': return '&quot;';
          }
        });
      }
    }
    function renderExportApp() {
      document.getElementById('exportApp').innerHTML = 
        `<div style="color:#fff">Fitur ekspor data inspeksi: Excel, CSV, PDF, JSON, TXT, XML.<br>Silakan gunakan menu pada Data Inspeksi untuk ekspor data.</div>`;
    }
    // ===== PENGATURAN: GANTI PASSWORD ADMIN =====
    document.getElementById('formGantiPassword').onsubmit = function(e) {
      e.preventDefault();
      let oldP = document.getElementById('oldPassword').value;
      let newP = document.getElementById('newPassword').value;
      let confP = document.getElementById('confirmPassword').value;
      let idx = admins.findIndex(a=>a.user===sessionStorage.getItem('adminLogin') && a.pass===oldP);
      if(idx===-1) {
        document.getElementById('passwordMsg').innerText = "Password lama salah!";
        return;
      }
      if(newP!==confP) {
        document.getElementById('passwordMsg').innerText = "Konfirmasi password tidak cocok!";
        return;
      }
      admins[idx].pass = newP;
      localStorage.setItem('admins', JSON.stringify(admins));
      document.getElementById('passwordMsg').innerText = "Password berhasil diganti!";
      document.getElementById('formGantiPassword').reset();
    };
  </script>
</body>
</html>
